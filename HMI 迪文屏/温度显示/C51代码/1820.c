 /*************************緩何蛍葎18B20議駁強殻會*************************************/
//#pragma SRC
#include <reg52.H>
#include <intrins.h>
#include <stdio.h>
sbit BEEP = P1^4;
unsigned char Decimal;

#define  NOP()   _nop_()   /* 協吶腎峺綜 */
#define  _Nop()  _nop_()   	*/

//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！			 
void TempDelay (unsigned char idata us);
void Init18b20 (void);
void WriteByte (unsigned char idata wr);  //汽忖准亟秘
void read_bytes (unsigned char idata j);
unsigned char CRC (unsigned char j);
void GemTemp (void);
void Config18b20 (void);
void ReadID (void);
void TemperatuerResult(void);
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！

sbit   D18B20=P3^7;  //梁業勧湖匂

bit  flag;
unsigned int  idata Temperature;
unsigned char idata temp_buff[9]; //贋刈響函議忖准read scratchpad葎9忖准read rom ID葎8忖准
unsigned char idata id_buff[8];
unsigned char idata *p,TIM;
unsigned char idata crc_data;

//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
unsigned char code CrcTable [256]={
0,  94, 188,  226,  97,  63,  221,  131,  194,  156,  126,  32,  163,  253,  31,  65,
157,  195,  33,  127,  252,  162,  64,  30,  95,  1,  227,  189,  62,  96,  130,  220,
35,  125,  159,  193,  66,  28,  254,  160,  225,  191,  93,  3,  128,  222,  60,  98,
190,  224,  2,  92,  223,  129,  99,  61,  124,  34,  192,  158,  29,  67,  161,  255,
70,  24,  250,  164,  39,  121,  155,  197,  132,  218,  56,  102,  229,  187,  89,  7,
219,  133, 103,  57,  186,  228,  6,  88,  25,  71,  165,  251,  120,  38,  196,  154,
101,  59, 217,  135,  4,  90,  184,  230,  167,  249,  27,  69,  198,  152,  122,  36,
248,  166, 68,  26,  153,  199,  37,  123,  58,  100,  134,  216,  91,  5,  231,  185,
140,  210, 48,  110,  237,  179,  81,  15,  78,  16,  242,  172,  47,  113,  147,  205,
17,  79,  173,  243,  112,  46,  204,  146,  211,  141,  111,  49,  178,  236,  14,  80,
175,  241, 19,  77,  206,  144,  114,  44,  109,  51,  209,  143,  12,  82,  176,  238,
50,  108,  142,  208,  83,  13,  239,  177,  240,  174,  76,  18,  145,  207,  45,  115,
202,  148, 118,  40,  171,  245,  23,  73,  8,  86,  180,  234,  105,  55,  213, 139,
87,  9,  235,  181,  54,  104,  138,  212,  149,  203,  41,  119,  244,  170,  72,  22,
233,  183,  85,  11,  136,  214,  52,  106,  43,  117,  151,  201,  74,  20,  246,  168,
116,  42,  200,  150,  21,  75,  169,  247,  182,  232,  10,  84,  215,  137,  107,  53}; 






//
/************************************************************
*Function:决扮侃尖
*parameter:
*Return:
*Modify:
*************************************************************/
void TempDelay (unsigned char idata us)
{
	while(us--);
}

/************************************************************
*Function:18B20兜兵晒
*parameter:
*Return:
*Modify:
*************************************************************/
void Init18b20 (void)
{
	D18B20=1;
	_nop_();
	D18B20=0;
	TempDelay(80);   //delay 530 uS//80
	_nop_();
	D18B20=1;
	TempDelay(14);   //delay 100 uS//14
	_nop_();
	_nop_();
	_nop_();
	
	if(D18B20==0)
		flag = 1;   //detect 1820 success!
	else
		flag = 0;    //detect 1820 fail!
	TempDelay(20);       //20
	_nop_();
	_nop_();
	D18B20 = 1;
}

/************************************************************
*Function:18B20亟秘匯倖忖准
*parameter:
*Return:
*Modify:
*************************************************************/
void WriteByte (unsigned char idata wr)  //汽忖准亟秘
{
	unsigned char idata i;
	for (i=0;i<8;i++)
	{
		D18B20 = 0;
		_nop_();
		D18B20=wr&0x01;
		TempDelay(3);   //delay 45 uS //5
		_nop_();
		_nop_();
		D18B20=1;
		wr >>= 1;
	}
}

/************************************************************
*Function:響18B20議匯倖忖准
*parameter:
*Return:
*Modify:
*************************************************************/
unsigned char ReadByte (void)     //響函汽忖准
{
	unsigned char idata i,u=0;
	for(i=0;i<8;i++)
	{
		D18B20 = 0;
		u >>= 1;
		D18B20 = 1;
		if(D18B20==1)
		u |= 0x80;
		TempDelay (2);
		_nop_();
	}
	return(u);
}

/************************************************************
*Function:響18B20
*parameter:
*Return:
*Modify:
*************************************************************/
void read_bytes (unsigned char idata j)
{
	 unsigned char idata i;
	 for(i=0;i<j;i++)
	 {
		  *p = ReadByte();
		  p++;
	 }
}

/************************************************************
*Function:CRC丕刮
*parameter:
*Return:
*Modify:
*************************************************************/
unsigned char CRC (unsigned char j)
{
   	unsigned char idata i,crc_data=0;
  	for(i=0;i<j;i++)  //臥燕丕刮
    	crc_data = CrcTable[crc_data^temp_buff[i]];
    return (crc_data);
}

/************************************************************
*Function:響函梁業
*parameter:
*Return:
*Modify:
*************************************************************/
void GemTemp (void)
{
   read_bytes (9);
   if (CRC(9)==0) //丕刮屎鳩
   {
	    Temperature = temp_buff[1]*0x100 + temp_buff[0];
//	    Temperature *= 0.625;
		Temperature /= 16; //函竃梁業屁方了
		Decimal=Temperature%16;
		TempDelay(1);
    }
}

/************************************************************
*Function:坪何塘崔
*parameter:
*Return:
*Modify:
*************************************************************/
void Config18b20 (void)  //嶷仟塘崔烏少浙峙才蛍掩楕
{
     Init18b20();
     WriteByte(0xcc);  //skip rom
     WriteByte(0x4e);  //write scratchpad
     WriteByte(0x19);  //貧
     WriteByte(0x1a);  //和
     WriteByte(0x7f);     //set 12 bit (0.125)
     Init18b20();
     WriteByte(0xcc);  //skip rom
     WriteByte(0x48);  //隠贋譜協峙
     Init18b20();
     WriteByte(0xcc);  //skip rom
     WriteByte(0xb8);  //指距譜協峙
}

/************************************************************
*Function:響18B20ID
*parameter:
*Return:
*Modify:
*************************************************************/
void ReadID (void)//響函匂周 id
{
	Init18b20();
	WriteByte(0x33);  //read rom
	read_bytes(8);
}

/************************************************************
*Function:18B20ID畠侃尖
*parameter:
*Return:
*Modify:
*************************************************************/
void TemperatuerResult(void)
{
  	p = id_buff;
  	ReadID();
  	Config18b20();
	Init18b20 ();
	WriteByte(0xcc);   //skip rom
	WriteByte(0x44);   //Temperature convert

	Init18b20 ();
	WriteByte(0xcc);   //skip rom
	WriteByte(0xbe);   //read Temperature
	p = temp_buff;
	GemTemp();
}
 //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
 //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！參貧頁DS18B20議光邁掀！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
 //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
 //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！參和頁麼痕方才堪笥械号荷恬才光窃方象廬算痕方！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！

 //决扮殻會
void delay(unsigned int i)
{
    char j;
    for(i; i > 0; i--)
        for(j = 200; j > 0; j--);
}
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
void system_Ini()
{
        SCON = 0x50;      //REN=1塋俯堪佩俊鞭彜蓑堪笥垢恬庁塀1    	       	   
	    TMOD|= 0x20;      //協扮匂垢恬圭塀2                    
		PCON|= 0x80;                                                          
		TH1 = 0xFA;		  //baud*2  /* reload value 9600、方象了8、唯峭了1。丼刮了涙 (11.0592) 
    	TL1 = 0xFA;         
		TR1  = 1;                                                             
		ES   = 1;        //蝕堪笥嶄僅                  
		EA   = 1;        // 蝕悳嶄僅	   
}
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
void UART_Send_Byte(unsigned char mydata)	// 窟僕匯倖忖准
{
 ES=0;
 TI=0;
 SBUF=mydata;
 while(!TI);
 TI=0;
 ES=1;
}
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
void UART_Send_Str(char *s)	  //窟僕猟云堪
{
 int i=0;
 while(s[i]!=0)
 {
 	UART_Send_Byte(s[i]);
 	i++;
 }
 
}

//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
void UART_Send_END(void)   //窟僕潤崩憲
{
	 UART_Send_Byte(0xFF);
	 UART_Send_Byte(0xFF);
	 UART_Send_Byte(0xFF);
}
//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
void Integer_character_Send(unsigned char N) //繍梁業方峙蛍盾葎 倖了噴了為了  旺廬算葎忖憲窟僕竃肇
{ unsigned char g,s,b,l;
  l=N;
  b=l/100; //蛍盾資誼為了方象 泌 117/100=1.17  徭強普肇弌方了誼  1
  l=l%100; //函噫方 普肇屁方了 誼 17
  s=l/10;  //17/10=1.7
  l=l%10;  //誼 7
  g=l;	   //  7

   //  48,49,50,51,52,53,54,55,56,57  忖憲忖准燕忖憲0-9議忖准鷹 
  if(b==0) // 為了葎 0 祥音窟僕阻
   {
	if(s==0); // 噴了葎 0 祥音窟僕阻
   	else UART_Send_Byte(s+48);
   }
   	else { 
   	UART_Send_Byte(b+48);  // 忖准48=忖憲0   泌惚為了頁1   1+48=49   軸=忖憲 ＾1￣
   	if(s==0); // 噴了葎 0 祥音窟僕阻
	else UART_Send_Byte(s+48);
    }

   UART_Send_Byte(g+48);   //倖了音砿頁音頁0  脅窟僕
}

//！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！
  main()
  {

 unsigned int ASC=0; 
 system_Ini(); //譜崔宥儷堪笥

    while(1)
   {		 
	 ASC++;
	 delay(500);

	 if(ASC>=110)   //决扮匯粁扮寂朔響函18B20梁業峙
	 {
	  ASC=0;
	  TemperatuerResult();//響梁業,,,響函欺議梁業贋壓匯倖延楚戦
	  delay(500);
	  //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！公猟云陣周験峙
	  
	  


	  if(Temperature<121)  //DS18B20 恷寄霞梁葎125業  侭參渣屯始塋120參和議梁業 
	   {
	  						   
	  UART_Send_Str("t0.txt="); //窟僕忖憲  																
	  UART_Send_Byte(34);  //窟僕匯倖忖准 葎 哈催  ,,猟云陣周議奉來TXT葎忖憲侏侭參俶勣窟僕哈催


	  Integer_character_Send(Temperature);// 委屁方方象 盾裂誼欺耽 匯了方廬葎忖憲鷹 朔 窟僕竃肇
	  UART_Send_Byte(46);  //窟僕弌方泣
	  Integer_character_Send(Decimal);	//窟僕弌方了廣DS18B20 議列餓葎0.5業侭參塋笑（了短焚担駅勣阻徭厘芦凌匯和


	  UART_Send_Byte(34);  //窟僕匯倖忖准 葎 哈催 
	  UART_Send_END();   //窟僕潤崩憲

	   }


	   //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！公序業訳陣周験峙
	   if(Temperature<100)//序業訳陣周議方峙泌惚階狛100祥氏涙丼,侭參寄噐100祥音公麿験峙阻
	   {
	   delay(10);
	   UART_Send_Str("j0.val=");
	   Integer_character_Send(Temperature);	 //序業訳val奉來頁屁方侏侭參音俶勣窟僕哈催
	   UART_Send_END();

	   }




	 }   	  	
    }  
  }
 //！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！！

